apiVersion: v1
kind: ConfigMap
metadata:
  name: openvpn-config
  namespace: infra
  labels:
    app: openvpn
data:
  # OpenVPN AS configuration template
  as.conf: |
    # Basic server configuration
    port=1194
    proto=udp
    dev=tun
    
    # Network settings
    vpn.client.routing.reroute_gw=true
    vpn.server.dhcp_option.dns.0=10.96.0.10
    vpn.server.dhcp_option.dns.1=8.8.8.8
    
    # Routes for Kubernetes networks
    vpn.client.routing.reroute_dns=true
    vpn.server.routing.private_network.0=10.96.0.0/12
    vpn.server.routing.private_network.1=10.244.0.0/16
    
    # Security
    vpn.tls_version_min=1.2
    vpn.server.cipher=AES-256-GCM
    
    # Performance
    vpn.server.port_share=943
    
  # Init script for initial setup
  init-config.sh: |
    #!/bin/bash
    # Initial configuration for OpenVPN AS
    
    # Wait for OpenVPN AS to start
    sleep 30
    
    # Configure via sacli (OpenVPN AS CLI)
    /usr/local/openvpn_as/scripts/sacli --key vpn.daemon.0.listen.port --value 1194 ConfigPut
    /usr/local/openvpn_as/scripts/sacli --key vpn.daemon.0.listen.protocol --value udp ConfigPut
    /usr/local/openvpn_as/scripts/sacli --key vpn.server.dhcp_option.dns.0 --value 10.96.0.10 ConfigPut
    /usr/local/openvpn_as/scripts/sacli --key vpn.server.dhcp_option.dns.1 --value 8.8.8.8 ConfigPut
    
    # Add routes
    /usr/local/openvpn_as/scripts/sacli --key vpn.server.routing.private_network.0 --value 10.96.0.0/12 ConfigPut
    /usr/local/openvpn_as/scripts/sacli --key vpn.server.routing.private_network.1 --value 10.244.0.0/16 ConfigPut
    
    # Restart to apply changes
    /usr/local/openvpn_as/scripts/sacli start